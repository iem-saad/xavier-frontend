<style>
  .water{
      width:200px;
      height: 200px;
      background-color: skyblue;
      border-radius: 50%;
      position: relative;
      box-shadow: inset 0 0 30px 0 rgba(0,0,0,.5), 0 4px 10px 0 rgba(0,0,0,.5);
      overflow: hidden;
  }
  .water:before, .water:after{
      content:'';
      position: absolute;
      width:200px;
      height: 400px;
      top:-220px;
      background-color: #fff;
  }
  .water:before{
      border-radius: 35%;
      background:rgba(255,255,255,.7);
      animation:wave 5s linear infinite;
  }
  .water:after{
      border-radius: 25%;
      background:rgba(255,255,255,.3);
      animation:wave 5s linear infinite;
  }
  @keyframes wave{
      0%{
          transform: rotate(0);
      }
      100%{
          transform: rotate(360deg);
      }
  }
</style>
<div class="row">
  <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
    <div class="card">
      <div class="card-body p-3">
        <div class="row">
          <div class="col-8">
            <div class="numbers">
              <p class="text-sm mb-0 text-capitalize font-weight-bold">Project Name</p>
              <h5 class="font-weight-bolder mb-0">
                <%= @project.name %>
              </h5>
            </div>
          </div>
          <div class="col-4 text-end">
            <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
              <i class="fa fa-file text-lg opacity-10" aria-hidden="true"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
    <div class="card">
      <div class="card-body p-3">
        <div class="row">
          <div class="col-8">
            <div class="numbers">
              <p class="text-sm mb-0 text-capitalize font-weight-bold">Original Models</p>
              <h5 class="font-weight-bolder mb-0">
                <%= @project.original_models.count %>
              </h5>
            </div>
          </div>
          <div class="col-4 text-end">
            <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
              <i class="fa fa-sitemap text-lg opacity-10" aria-hidden="true"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
    <div class="card">
      <div class="card-body p-3">
        <div class="row">
          <div class="col-8">
            <div class="numbers">
              <p class="text-sm mb-0 text-capitalize font-weight-bold"> Mutated Models</p>
              <h5 class="font-weight-bolder mb-0">
                <%= @project.original_models.count %>
              </h5>
            </div>
          </div>
          <div class="col-4 text-end">
            <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
              <i class="fa fa-bacterium text-lg opacity-10" aria-hidden="true"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-xl-3 col-sm-6">
    <div class="card">
      <div class="card-body p-3">
        <div class="row">
          <div class="col-8">
            <div class="numbers">
              <p class="text-sm mb-0 text-capitalize font-weight-bold">Value of K</p>
              <h5 class="font-weight-bolder mb-0">
                <%= @project.hyper_params.dig("k_value") %>
              </h5>
            </div>
          </div>
          <div class="col-4 text-end">
            <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
              <i class="fa fa-refresh text-lg opacity-10" aria-hidden="true"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row my-3">
  <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
    <div class="card">
      <div class="card-body p-3">
        <div class="row">
          <div class="col-8">
            <div class="numbers">
              <p class="text-sm mb-0 text-capitalize font-weight-bold">Project Status</p>
              <h5 class="font-weight-bolder mb-0 badge badge-sm bg-gradient-<%= @project.completed? ? 'success' : 'secondary' %>">
                <%= @project.status %>
              </h5>
            </div>
          </div>
          <div class="col-4 text-end">
            <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
              <i class="fa fa-signal text-lg opacity-10" aria-hidden="true"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
    <div class="card">
      <div class="card-body p-3">
        <div class="row">
          <div class="col-8">
            <div class="numbers">
              <p class="text-sm mb-0 text-capitalize font-weight-bold">Model Selected</p>
              <p class="font-weight-bolder mb-0">
                <%= @project.hyper_params.dig("model") %>
              </p>
            </div>
          </div>
          <div class="col-4 text-end">
            <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
              <i class="fa fa-atom text-lg opacity-10" aria-hidden="true"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
    <div class="card">
      <div class="card-body p-3">
        <div class="row">
          <div class="col-8">
            <div class="numbers">
              <p class="text-sm mb-0 font-weight-bold"> Mutation at layer</p>
              <h5 class="font-weight-bolder mb-0">
                <%= @project.hyper_params.dig("layer") %>
              </h5>
            </div>
          </div>
          <div class="col-4 text-end">
            <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
              <i class="fa fa-layer-group text-lg opacity-10" aria-hidden="true"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-xl-3 col-sm-6">
    <div class="card">
      <div class="card-body p-3">
        <div class="row">
          <div class="col-8">
            <div class="numbers">
              <p class="text-sm mb-0 text-capitalize font-weight-bold">Operator Applied</p>
              <h6 class="font-weight-bolder mb-0">
                <%= @project.hyper_params.dig("operator_type") %>
              </h6>
            </div>
          </div>
          <div class="col-4 text-end">
            <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
              <i class="fa fa-calculator text-lg opacity-10" aria-hidden="true"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<div class="row mt-4">
  <div class="col-lg-7 mb-lg-0 mb-4">
    <div class="card">
      <div class="card-body p-3">
        <div class="row">
          <div class="col-lg-6">
            <div class="d-flex flex-column h-100">
              <h5 class="font-weight-bolder">Project Description</h5>
              <p class="mb-5"><%= @project.description %></p>
              <a class="text-body text-sm font-weight-bold mb-0 icon-move-right mt-auto" href="javascript:;">
               Project was Created <%= time_ago_in_words(@project.created_at)%> ago
              </a>
            </div>
          </div>
          <div class="col-lg-5 ms-auto text-center mt-5 mt-lg-0">
            <div class="bg-gradient-primary border-radius-lg h-100">
              <div class="position-relative d-flex align-items-center justify-content-center h-100">
                <%= image_tag "neural_net.png", class: "position-relative z-index-2", style: "height: 150px;" %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-5">
    <div class="card h-100 p-3">
      <div class="overflow-hidden position-relative border-radius-lg bg-cover h-100">
        <span class="mask bg-gradient-primary"></span>
        <div class="card-body position-relative z-index-1 d-flex flex-column h-100 p-3">
          <h5 class="text-white font-weight-bolder mb-4 pt-2">Operator Configurations are as following.</h5>
          <p class="text-white"><%= operator_conf(@project) %></p>
        </div>
      </div>
    </div>
  </div>
</div>
<% if @project.in_progress? %>
<div class="row" style="display: flex; justify-content: center;">
  <div class="water my-4"></div>
  <div style="display: flex; justify-content: center;"><h3>Processing...</h3>
  </div>
</div>
<% end %>

<% if @project.completed? %>
<div class="row card mt-4 m-1">
  <h3 class="p-3 mx-3">Results</h3>
  <h5 class="mx-3">Status: <%= @project.results.dig("status") %></h5>
  <h5 class="mx-3">Beta: <%= @project.results.dig("Beta") %></h5>
  <h5 class="mx-3">P-Value: <%= @project.results.dig("P-Value") %></h5>
  <h5 class="mx-3">Effect Size: <%= @project.results.dig("Effect Size") %></h5>
  <% if @project.results.dig("Mutation") %>
    <h5 class="mx-3 text-success">Mutation is Successfully Killed!</h5>
  <% else %>
    <h5 class="mx-3 text-danger">Ops, Mutation is Not Killed!</h5>
  <% end %>
  <div class="row">
    <div class="col-1">
      <button type="button" class="btn btn-secondary mx-3" data-toggle="modal" data-target="#exampleModalCenter" onclick="open_mutation_modal(this);">
        Download Models
      </button>
    </div>
  </div>
</div>
<div id="analysis-grid" class="d-none">
  <div class="row card mt-4 m-1">
    <h3 class="p-3 mx-3">Mutation Analysis (Graphical)</h3>
    <div class="accordion accordion-flush" id="accordionFlushExample">
      <%["overall_accuracy", "overall_precision", "accuracy", "specificity", "sensitivity", "precision", "recall", "f1_score", "AUC", "F_beta"].each_with_index do |matric, m_index|%>
        <div class="accordion-item card-body p-3">
          <h2 class="accordion-header" id="flush-heading<%=m_index%>">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapse<%=m_index%>" aria-expanded="false" aria-controls="flush-collapse<%=m_index%>">
              <%= "#{@project.hyper_params&.dig("model")}-#{matric}" %>
              <i class="fa fa-arrow-down mx-4 pull-right"></i>
            </button>
          </h2>
          <div id="flush-collapse<%=m_index%>" class="accordion-collapse collapse" aria-labelledby="flush-heading<%=m_index%>" data-bs-parent="#accordionFlushExample2">
            <div class="accordion-body">
              <div class="row">
                <% @project.original_models.each_with_index do |model, index| %>
                  <% next if model.mutated_model.nil? %>
                  <% org_data = model.matrices[m_index][matric].values.map(&:to_f) %>
                  <% mutated_data = model.mutated_model.matrices[m_index][matric].values.map(&:to_f) %>
                  <% if matric.include?("overall") %>
                    <%= render 'bar_chart', type: matric, id: matric, org_data: org_data, mutated_data: mutated_data, index: index %>
                  <% else %>
                    <%= render 'linear_graph', type: matric, id: matric, org_data: org_data, mutated_data: mutated_data, index: index %>
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <div class="row card mt-4 m-1">
    <h3 class="p-3 mx-3">Mutation Analysis (Tabular)</h3>
    <div class="accordion accordion-flush" id="accordionFlushExample">
      <%["overall_accuracy", "overall_precision", "accuracy", "specificity", "sensitivity", "precision", "recall", "f1_score", "AUC", "F_beta"].each_with_index do |matric, m_index|%>
        <div class="accordion-item card-body p-3">
          <h2 class="accordion-header" id="tabular-flush-heading<%=m_index%>">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#tabular-flush-collapse<%=m_index%>" aria-expanded="false" aria-controls="tabular-flush-collapse<%=m_index%>">
              <%= "#{@project.hyper_params&.dig("model")}-#{matric}" %>
              <i class="fa fa-arrow-down mx-4 pull-right"></i>
            </button>
          </h2>
          <div id="tabular-flush-collapse<%=m_index%>" class="accordion-collapse collapse" aria-labelledby="tabular-flush-heading<%=m_index%>" data-bs-parent="#accordionFlushExample2">
            <div class="accordion-body">
              <div class="row">
                <% @project.original_models.each_with_index do |model, index| %>
                  <% next if model.mutated_model.nil? %>
                  <% org_data = model.matrices[m_index][matric].values.map(&:to_f) %>
                  <% mutated_data = model.mutated_model.matrices[m_index][matric].values.map(&:to_f) %>
                  <% if matric.include?("overall") %>
                    <%= render 'overall_tabular_analysis_tile', org_val: org_data[0], mutated_val: mutated_data[0], title: matric, index: index %>
                  <% else %>
                    <%= render 'tabular_analysis_tile', org_vals: org_data, mutated_vals: mutated_data, title: matric, index: index %>
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
<div class="modal fade" id="downloadModelsModal" tabindex="-1" aria-labelledby="downloadModelsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="downloadModelsModalLabel">Please Select a Model to Download</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <h6>Following are Models Used in this project: </h6>
      </div>
      <div class="row">
        <div class="col">
          <div class="card h-100">
            <div class="card-header pb-0 p-3">
              <div class="row">
                <div class="col-6 d-flex align-items-center">
                  <h6 class="mb-0">Models</h6>
                </div>
                <div class="col-6 text-end">
                  <%= link_to "How to Use Exported Model", use_exported_model_path, class: "btn btn-outline-secondary btn-sm mb-0", target: "_blank" %>
                </div>
              </div>
            </div>
            <div class="card-body p-3 pb-0">
              <ul class="list-group">
                <% @project.original_models.each_with_index do |org_model, index| %>
                <li class="list-group-item border-0 d-flex justify-content-between ps-0 mb-2 border-radius-lg">
                  <div class="d-flex flex-column">
                    <h6 class="mb-1 text-dark font-weight-bold text-sm">Model # <%= index + 1%></h6>
                    <span class="text-xs">Created <%= time_ago_in_words(org_model.created_at)%> ago</span>
                  </div>
                  <div class="d-flex align-items-center text-sm">
                    <%= link_to download_org_model_path(id: org_model.id, index: index+1), class: "btn btn-link text-dark  mb-0 px-0 ms-4", style: "font-size: 9px;" do  %>
                      <i class="fa fa-download text-lg me-1 py-1"></i> Download Model
                    <% end %>
                    <%= link_to download_mutated_model_path(id: org_model.id, index: index+1), class: "btn btn-link text-dark mb-0 px-0 ms-4", style: "font-size: 9px;" do  %>
                      <i class="fa fa-download text-lg me-1 py-1"></i> Download Mutant
                    <% end %>
                  </div>
                </li>
                <% end %>
              </ul>
            </div>
          </div>
        </div>
      </div>
     
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<% end %>
<div class="text-center">
  <div class="spinner-border" style="width: 5rem; height: 5rem;" role="status" id="loader">
    <span class="sr-only">Loading...</span>
  </div>
</div>

<script type="text/javascript">
  document.onreadystatechange = function() {
    if (document.readyState !== "complete") {
      document.querySelector("#loader").style.visibility = "visible";
    } else {
      document.querySelector("#loader").style.display = "none";
      document.querySelector("#analysis-grid").classList.remove('d-none');
    }
  };
  function open_mutation_modal(event) {
    $('#downloadModelsModal').modal('toggle');
  }
</script>